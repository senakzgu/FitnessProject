@model FitnessApp.Models.Appointment

@{
    ViewData["Title"] = "Edit Appointment";
}

<h1>Edit Appointment</h1>
<hr />

<div class="row">
    <div class="col-md-4">
        <form asp-action="Edit">

            <input type="hidden" asp-for="Id" />

            <div class="form-group">
                <label asp-for="MemberName"></label>
                <input asp-for="MemberName" class="form-control" />
            </div>

            <div class="form-group">
                <label asp-for="GymId"></label>
                <select asp-for="GymId" id="GymId" class="form-control" asp-items="ViewBag.GymId">
                    <option value="">Salon seçiniz</option>
                </select>
            </div>

            <div class="form-group">
                <label asp-for="ServiceId"></label>
                <select asp-for="ServiceId" id="ServiceId" class="form-control" asp-items="ViewBag.ServiceId">
                    <option value="">Hizmet seçiniz</option>
                </select>
            </div>

            <div class="form-group">
                <label asp-for="TrainerId"></label>
                <select asp-for="TrainerId" id="TrainerId" class="form-control" asp-items="ViewBag.TrainerId">
                    <option value="">Eğitmen seçiniz</option>
                </select>
            </div>

            <div class="form-group">
                <label asp-for="Date"></label>
                <input asp-for="Date" type="date" class="form-control" />
            </div>

            <div class="form-group">
                <label asp-for="Time"></label>
                <select asp-for="Time" id="timeDropdown" class="form-control">
                    <option value="">Saat seçiniz</option>
                </select>
            </div>

            <div class="form-group">
                <label asp-for="Price"></label>
                <input asp-for="Price" id="Price" class="form-control" />
            </div>

            <div class="form-group form-check">
                <label class="form-check-label">
                    <input class="form-check-input" asp-for="IsApproved" />
                    @Html.DisplayNameFor(m => m.IsApproved)
                </label>
            </div>

            <button type="submit" class="btn btn-primary">Kaydet</button>
        </form>
    </div>
</div>

<div>
    <a asp-action="Index">Geri</a>
</div>

@section Scripts {
    <script>

// ============= GYM → SERVICES =============
document.getElementById("GymId").addEventListener("change", function () {
    const gymId = this.value;

    fetch(`/Appointments/GetServicesByGym?gymId=${gymId}`)
        .then(res => res.json())
        .then(services => {

            const serviceDropdown = document.getElementById("ServiceId");
            serviceDropdown.innerHTML = "<option value=''>Hizmet seçiniz</option>";

            services.forEach(s => {
                const opt = document.createElement("option");
                opt.value = s.id;
                opt.text = s.name;
                serviceDropdown.appendChild(opt);
            });

            clearTrainer();
            clearHours();
            clearPrice();
        });
});

// ============= SERVICE → TRAINERS =============
document.getElementById("ServiceId").addEventListener("change", function () {
    const serviceId = this.value;

    fetch(`/Appointments/GetTrainersByService?serviceId=${serviceId}`)
        .then(res => res.json())
        .then(trainers => {

            const trainerDropdown = document.getElementById("TrainerId");
            trainerDropdown.innerHTML = "<option value=''>Eğitmen seçiniz</option>";

            trainers.forEach(t => {
                const opt = document.createElement("option");
                opt.value = t.id;
                opt.text = t.name;
                trainerDropdown.appendChild(opt);
            });

            clearHours();
        });

    fetch(`/Appointments/GetServicePrice?serviceId=${serviceId}`)
        .then(res => res.json())
        .then(price => { document.getElementById("Price").value = price; });
});

// ============= TRAINER → HOURS =============
document.getElementById("TrainerId").addEventListener("change", function () {
    const trainerId = this.value;

    fetch(`/Appointments/GetAvailableHours?trainerId=${trainerId}`)
        .then(res => res.json())
        .then(hours => {
            const timeDropdown = document.getElementById("timeDropdown");
            timeDropdown.innerHTML = "<option value=''>Saat seçiniz</option>";

            hours.forEach(h => {
                const opt = document.createElement("option");
                opt.value = h;
                opt.text = h;
                timeDropdown.appendChild(opt);
            });

            // Mevcut saati geri seç
            const current = "@Model.Time";
            if (current) timeDropdown.value = current;
        });
});

// ======= Yardımcı Temizleyiciler =========
function clearTrainer() {
    document.getElementById("TrainerId").innerHTML =
        "<option value=''>Önce hizmet seçiniz</option>";
}

function clearHours() {
    document.getElementById("timeDropdown").innerHTML =
        "<option value=''>Saat seçiniz</option>";
}

function clearPrice() {
    document.getElementById("Price").value = "";
}

// ========= Sayfa açıldığında mevcut değerleri yükle =========
document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("GymId").dispatchEvent(new Event("change"));
    setTimeout(() => {
        document.getElementById("ServiceId").dispatchEvent(new Event("change"));
    }, 200);
    setTimeout(() => {
        document.getElementById("TrainerId").dispatchEvent(new Event("change"));
    }, 400);
});

    </script>
}
